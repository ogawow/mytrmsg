<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Flex Message Editor</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4">
        <div class="w-full max-w-md mx-auto bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h1 class="text-2xl font-bold mb-4">LIFF Flex Message Editor</h1>
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">ã‚¨ãƒ©ãƒ¼</strong>
                <span id="errorMessage" class="block sm:inline"></span>
            </div>
            <div id="profile" class="hidden flex items-center space-x-4 mb-4">
                <img id="profileImage" class="h-10 w-10 rounded-full" src="" alt="Profile Image">
                <div>
                    <p id="displayName" class="font-semibold"></p>
                    <p id="statusMessage" class="text-sm text-gray-500"></p>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="trainerName">
                    ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="trainerName" type="text" placeholder="ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼åã‚’å…¥åŠ›">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="friendUrl">
                    å‹ã ã¡è¿½åŠ URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="friendUrl" type="text" placeholder="https://line.me/R/ti/p/@example">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="adminUrl">
                    ç®¡ç†ç”»é¢URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="adminUrl" type="text" placeholder="https://example.com/mytrainer-admin">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="managerUrl">
                    LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”»é¢URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="managerUrl" type="text" placeholder="https://manager.line.biz">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="customBubbles">
                    ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ–ãƒ« (JSON)
                </label>
                <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="customBubbles" rows="10" placeholder='[
  {
    "header_text": "ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼",
    "header_color": "#FF0000",
    "body_contents": [
      {
        "type": "text",
        "text": "ã‚«ã‚¹ã‚¿ãƒ ãƒœãƒ‡ã‚£ãƒ†ã‚­ã‚¹ãƒˆ",
        "wrap": true
      }
    ],
    "footer_contents": [
      {
        "type": "button",
        "style": "primary",
        "action": {
          "type": "uri",
          "label": "ãƒœã‚¿ãƒ³",
          "uri": "https://example.com"
        }
      }
    ],
    "bubble_styles": {
      "header": { "backgroundColor": "#FF0000" },
      "body": { "backgroundColor": "#FFFFFF" },
      "footer": { "backgroundColor": "#EEEEEE" }
    }
  }
]'></textarea>
            </div>
            <div class="flex items-center justify-between mb-4">
                <button id="sendMessageBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                </button>
                <button id="shareMessageBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±æœ‰
                </button>
            </div>
            <div>
                <button id="loginLogoutBtn" class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    LINEã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            <div class="mt-4">
                <h3 class="text-sm font-medium text-gray-700">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
                <pre id="debugInfo" class="mt-1 text-xs bg-gray-100 p-2 rounded"></pre>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = '2006675074-MdB7kQmZ';
        let isLoggedIn = false;

        function createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles) {
            const firstBubble = {
                "type": "bubble",
                "header": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": "ğŸ‰ ç’°å¢ƒç™ºè¡Œå®Œäº†ï¼",
                            "weight": "bold",
                            "size": "xl",
                            "align": "center",
                            "color": "#FFFFFF"
                        },
                        {
                            "type": "text",
                            "text": `${trainerName}ã•ã‚“ã‚’ãƒã‚¤ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã«éŒ¬æˆã—ã¾ã—ãŸï¼`,
                            "size": "sm",
                            "color": "#FFFFFF",
                            "align": "center",
                            "margin": "md"
                        }
                    ],
                    "backgroundColor": "#27ACB2",
                    "paddingAll": "20px"
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "1ï¸âƒ£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "ã¾ãšã¯ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "å‹ã ã¡è¿½åŠ ã™ã‚‹",
                                        "uri": friendUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "2ï¸âƒ£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "MY TRAINERç®¡ç†ç”»é¢",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æŒ‡å°å†…å®¹ã®è¨­å®šã‚„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¿½åŠ ãŒã§ãã¾ã™",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "ç®¡ç†ç”»é¢ã‚’é–‹ã",
                                        "uri": adminUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md",
                            "margin": "lg"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "3ï¸âƒ£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”»é¢",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "ãƒãƒ£ãƒƒãƒˆã§ã®ã‚„ã‚Šå–ã‚Šã‚„å„ç¨®è¨­å®šãŒã§ãã¾ã™",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "ç®¡ç†ç”»é¢ã‚’é–‹ã",
                                        "uri": managerUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md",
                            "margin": "lg"
                        }
                    ],
                    "paddingAll": "20px"
                },
                "styles": {
                    "body": {
                        "backgroundColor": "#F8F9FA"
                    }
                }
            };

            const bubbles = [firstBubble];

            customBubbles.forEach(customBubble => {
                bubbles.push({
                    "type": "bubble",
                    "header": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": customBubble.header_text,
                                "weight": "bold",
                                "size": "xl",
                                "color": "#FFFFFF"
                            }
                        ],
                        "backgroundColor": customBubble.header_color,
                        "paddingAll": "20px"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": customBubble.body_contents,
                        "paddingAll": "20px"
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": customBubble.footer_contents
                    },
                    "styles": customBubble.bubble_styles
                });
            });

            return {
                "type": "carousel",
                "contents": bubbles
            };
        }

        function setDebugInfo(info) {
            document.getElementById('debugInfo').textContent += info + '\n';
        }

        function showError(info) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorDiv.classList.remove('hidden');
            errorMessage.textContent = info;
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.add('hidden');
        }

        function updateLoginButton() {
            const loginLogoutBtn = document.getElementById('loginLogoutBtn');
            loginLogoutBtn.textContent = isLoggedIn ? 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ' : 'LINEã§ãƒ­ã‚°ã‚¤ãƒ³';
        }

        async function initializeLiff() {
            try {
                setDebugInfo('LIFFåˆæœŸåŒ–é–‹å§‹...');
                await liff.init({ liffId: LIFF_ID });
                setDebugInfo('LIFFåˆæœŸåŒ–æˆåŠŸ');
                if (liff.isLoggedIn()) {
                    isLoggedIn = true;
                    setDebugInfo('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿');
                    await fetchProfile();
                } else {
                    setDebugInfo('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æœªãƒ­ã‚°ã‚¤ãƒ³');
                }
                updateLoginButton();
            } catch (error) {
                console.error('LIFF initialization failed', error);
                showError(`LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                setDebugInfo(`LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function fetchProfile() {
            setDebugInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—é–‹å§‹...');
            if (!liff.isLoggedIn()) {
                showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                setDebugInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœªãƒ­ã‚°ã‚¤ãƒ³');
                return;
            }

            try {
                const accessToken = liff.getAccessToken();
                setDebugInfo(`ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: ${accessToken ? 'å–å¾—æˆåŠŸ' : 'å–å¾—å¤±æ•—'}`);
                
                const profile = await liff.getProfile();
                document.getElementById('profile').classList.remove('hidden');
                document.getElementById('profileImage').src = profile.pictureUrl;
                document.getElementById('displayName').textContent = profile.displayName;
                document.getElementById('statusMessage').textContent = profile.statusMessage || '';
                setDebugInfo('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ');
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                setDebugInfo(`ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function handleLogin() {
            if (!liff.isLoggedIn()) {
                setDebugInfo('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹...');
                try {
                    await liff.login();
                    isLoggedIn = true;
                    setDebugInfo('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
                    await fetchProfile();
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    showError(`ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    setDebugInfo(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            } else {
                setDebugInfo('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†é–‹å§‹...');
                liff.logout();
                isLoggedIn = false;
                document.getElementById('profile').classList.add('hidden');
                setDebugInfo('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
            }
            updateLoginButton();
        }

        async function sendMessage() {
            setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–‹å§‹...');
            if (!liff.isLoggedIn()) {
                showError('LINEã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: æœªãƒ­ã‚°ã‚¤ãƒ³');
                return;
            }

            if (!liff.isInClient()) {
                showError('ã“ã®ã‚¢ãƒ—ãƒªã¯LINEå†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚');
                setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: LINEå¤–ã§ã®å®Ÿè¡Œ');
                return;
            }

            const trainerName = document.getElementById('trainerName').value;
            const friendUrl = document.getElementById('friendUrl').value;
            const adminUrl = document.getElementById('adminUrl').value;
            const managerUrl = document.getElementById('managerUrl').value;
            const customBubblesJson = document.getElementById('customBubbles').value;

            let customBubbles = [];
            try {
                customBubbles = JSON.parse(customBubblesJson);
            } catch (error) {
                showError('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ–ãƒ«ã®JSONãŒç„¡åŠ¹ã§ã™ã€‚');
                setDebugInfo(`ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ–ãƒ«JSONã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return;
            }

            const flexMessage = createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles);

            try {
                await liff.sendMessages([
                    {
                        type: 'flex',
                        altText: 'MY TRAINERç’°å¢ƒç™ºè¡Œå®Œäº†',
                        contents: flexMessage
                    }
                ]);
                setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ');
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼');
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                setDebugInfo(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function shareMessage() {
            setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰é–‹å§‹...');
            if (!liff.isLoggedIn()) {
                showError('LINEã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰ã‚¨ãƒ©ãƒ¼: æœªãƒ­ã‚°ã‚¤ãƒ³');
                return;
            }

            const trainerName = document.getElementById('trainerName').value;
            const friendUrl = document.getElementById('friendUrl').value;
            const adminUrl = document.getElementById('adminUrl').value;
            const managerUrl = document.getElementById('managerUrl').value;
            const customBubblesJson = document.getElementById('customBubbles').value;

            let customBubbles = [];
            try {
                customBubbles = JSON.parse(customBubblesJson);
            } catch (error) {
                showError('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ–ãƒ«ã®JSONãŒç„¡åŠ¹ã§ã™ã€‚');
                setDebugInfo(`ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ–ãƒ«JSONã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return;
            }

            const flexMessage = createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles);

            try {
                const result = await liff.shareTargetPicker([
                    {
                        type: 'flex',
                        altText: 'MY TRAINERç’°å¢ƒç™ºè¡Œå®Œäº†',
                        contents: flexMessage
                    }
                ]);
                if (result) {
                    setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰æˆåŠŸ');
                    alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£å¸¸ã«å…±æœ‰ã•ã‚Œã¾ã—ãŸï¼');
                } else {
                    setDebugInfo('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                }
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                setDebugInfo(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…±æœ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        document.getElementById('loginLogoutBtn').addEventListener('click', handleLogin);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('shareMessageBtn').addEventListener('click', shareMessage);

        initializeLiff();
    </script>
</body>
</html>

