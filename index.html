<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Flex Message Editor</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4">
        <div class="w-full max-w-md mx-auto bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h1 class="text-2xl font-bold mb-4">LIFF Flex Message Editor</h1>
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">„Ç®„É©„Éº</strong>
                <span id="errorMessage" class="block sm:inline"></span>
            </div>
            <div id="profile" class="hidden flex items-center space-x-4 mb-4">
                <img id="profileImage" class="h-10 w-10 rounded-full" src="" alt="Profile Image">
                <div>
                    <p id="displayName" class="font-semibold"></p>
                    <p id="statusMessage" class="text-sm text-gray-500"></p>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="trainerName">
                    „Éà„É¨„Éº„Éä„ÉºÂêç
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="trainerName" type="text" placeholder="„Éà„É¨„Éº„Éä„ÉºÂêç„ÇíÂÖ•Âäõ">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="friendUrl">
                    Âèã„Å†„Å°ËøΩÂä†URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="friendUrl" type="text" placeholder="https://line.me/R/ti/p/@example">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="adminUrl">
                    ÁÆ°ÁêÜÁîªÈù¢URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="adminUrl" type="text" placeholder="https://example.com/mytrainer-admin">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="managerUrl">
                    LINEÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜÁîªÈù¢URL
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="managerUrl" type="text" placeholder="https://manager.line.biz">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="customBubbles">
                    „Ç´„Çπ„Çø„É†„Éê„Éñ„É´ (JSON)
                </label>
                <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="customBubbles" rows="10" placeholder='[
  {
    "header_text": "„Ç´„Çπ„Çø„É†„Éò„ÉÉ„ÉÄ„Éº",
    "header_color": "#FF0000",
    "body_contents": [
      {
        "type": "text",
        "text": "„Ç´„Çπ„Çø„É†„Éú„Éá„Ç£„ÉÜ„Ç≠„Çπ„Éà",
        "wrap": true
      }
    ],
    "footer_contents": [
      {
        "type": "button",
        "style": "primary",
        "action": {
          "type": "uri",
          "label": "„Éú„Çø„É≥",
          "uri": "https://example.com"
        }
      }
    ],
    "bubble_styles": {
      "header": { "backgroundColor": "#FF0000" },
      "body": { "backgroundColor": "#FFFFFF" },
      "footer": { "backgroundColor": "#EEEEEE" }
    }
  }
]'></textarea>
            </div>
            <div class="flex items-center justify-between mb-4">
                <button id="sendMessageBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                </button>
                <button id="shareMessageBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ±Êúâ
                </button>
            </div>
            <div>
                <button id="loginLogoutBtn" class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    LINE„Åß„É≠„Ç∞„Ç§„É≥
                </button>
            </div>
            <div class="mt-4">
                <h3 class="text-sm font-medium text-gray-700">„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</h3>
                <pre id="debugInfo" class="mt-1 text-xs bg-gray-100 p-2 rounded"></pre>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = '2006675074-MdB7kQmZ';
        let isLoggedIn = false;

        function createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles) {
            const firstBubble = {
                "type": "bubble",
                "header": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": "üéâ Áí∞Â¢ÉÁô∫Ë°åÂÆå‰∫ÜÔºÅ",
                            "weight": "bold",
                            "size": "xl",
                            "align": "center",
                            "color": "#FFFFFF"
                        },
                        {
                            "type": "text",
                            "text": `${trainerName}„Åï„Çì„Çí„Éû„Ç§„Éà„É¨„Éº„Éä„Éº„Å´Èå¨Êàê„Åó„Åæ„Åó„ÅüÔºÅ`,
                            "size": "sm",
                            "color": "#FFFFFF",
                            "align": "center",
                            "margin": "md"
                        }
                    ],
                    "backgroundColor": "#27ACB2",
                    "paddingAll": "20px"
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "1Ô∏è‚É£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "ÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂèã„Å†„Å°ËøΩÂä†",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "„Åæ„Åö„ÅØ„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†„Åó„Å¶Âãï‰ΩúÁ¢∫Ë™ç„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "Âèã„Å†„Å°ËøΩÂä†„Åô„Çã",
                                        "uri": friendUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "2Ô∏è‚É£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "MY TRAINERÁÆ°ÁêÜÁîªÈù¢",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÊåáÂ∞éÂÜÖÂÆπ„ÅÆË®≠ÂÆö„ÇÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆËøΩÂä†„Åå„Åß„Åç„Åæ„Åô",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "ÁÆ°ÁêÜÁîªÈù¢„ÇíÈñã„Åè",
                                        "uri": adminUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md",
                            "margin": "lg"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "horizontal",
                                    "contents": [
                                        {
                                            "type": "text",
                                            "text": "3Ô∏è‚É£",
                                            "size": "lg",
                                            "flex": 1
                                        },
                                        {
                                            "type": "box",
                                            "layout": "vertical",
                                            "contents": [
                                                {
                                                    "type": "text",
                                                    "text": "LINEÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜÁîªÈù¢",
                                                    "size": "md",
                                                    "color": "#555555",
                                                    "weight": "bold"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "„ÉÅ„É£„ÉÉ„Éà„Åß„ÅÆ„ÇÑ„ÇäÂèñ„Çä„ÇÑÂêÑÁ®ÆË®≠ÂÆö„Åå„Åß„Åç„Åæ„Åô",
                                                    "size": "xs",
                                                    "color": "#888888",
                                                    "wrap": true,
                                                    "margin": "sm"
                                                }
                                            ],
                                            "flex": 5
                                        }
                                    ]
                                },
                                {
                                    "type": "button",
                                    "action": {
                                        "type": "uri",
                                        "label": "ÁÆ°ÁêÜÁîªÈù¢„ÇíÈñã„Åè",
                                        "uri": managerUrl
                                    },
                                    "style": "primary",
                                    "color": "#27ACB2",
                                    "margin": "md"
                                }
                            ],
                            "backgroundColor": "#FFFFFF",
                            "cornerRadius": "md",
                            "paddingAll": "md",
                            "margin": "lg"
                        }
                    ],
                    "paddingAll": "20px"
                },
                "styles": {
                    "body": {
                        "backgroundColor": "#F8F9FA"
                    }
                }
            };

            const bubbles = [firstBubble];

            customBubbles.forEach(customBubble => {
                bubbles.push({
                    "type": "bubble",
                    "header": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": customBubble.header_text,
                                "weight": "bold",
                                "size": "xl",
                                "color": "#FFFFFF"
                            }
                        ],
                        "backgroundColor": customBubble.header_color,
                        "paddingAll": "20px"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": customBubble.body_contents,
                        "paddingAll": "20px"
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": customBubble.footer_contents
                    },
                    "styles": customBubble.bubble_styles
                });
            });

            return {
                "type": "carousel",
                "contents": bubbles
            };
        }

        function setDebugInfo(info) {
            document.getElementById('debugInfo').textContent += info + '\n';
        }

        function showError(info) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorDiv.classList.remove('hidden');
            errorMessage.textContent = info;
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.add('hidden');
        }

        function updateLoginButton() {
            const loginLogoutBtn = document.getElementById('loginLogoutBtn');
            loginLogoutBtn.textContent = isLoggedIn ? '„É≠„Ç∞„Ç¢„Ç¶„Éà' : 'LINE„Åß„É≠„Ç∞„Ç§„É≥';
        }

        async function initializeLiff() {
            try {
                setDebugInfo('LIFFÂàùÊúüÂåñÈñãÂßã...');
                await liff.init({ liffId: LIFF_ID });
                setDebugInfo('LIFFÂàùÊúüÂåñÊàêÂäü');
                if (liff.isLoggedIn()) {
                    isLoggedIn = true;
                    setDebugInfo('„É¶„Éº„Ç∂„Éº„ÅØ„É≠„Ç∞„Ç§„É≥Ê∏à„Åø');
                    await fetchProfile();
                } else {
                    setDebugInfo('„É¶„Éº„Ç∂„Éº„ÅØÊú™„É≠„Ç∞„Ç§„É≥');
                }
                updateLoginButton();
            } catch (error) {
                console.error('LIFF initialization failed', error);
                showError(`LIFF„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                setDebugInfo(`LIFFÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`);
            }
        }

        async function fetchProfile() {
            setDebugInfo('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÈñãÂßã...');
            if (!liff.isLoggedIn()) {
                showError('„É¶„Éº„Ç∂„Éº„Åå„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                setDebugInfo('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº: „É¶„Éº„Ç∂„Éº„ÅåÊú™„É≠„Ç∞„Ç§„É≥');
                return;
            }

            try {
                const accessToken = liff.getAccessToken();
                setDebugInfo(`„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥: ${accessToken ? 'ÂèñÂæóÊàêÂäü' : 'ÂèñÂæóÂ§±Êïó'}`);
                
                const profile = await liff.getProfile();
                document.getElementById('profile').classList.remove('hidden');
                document.getElementById('profileImage').src = profile.pictureUrl;
                document.getElementById('displayName').textContent = profile.displayName;
                document.getElementById('statusMessage').textContent = profile.statusMessage || '';
                setDebugInfo('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÊàêÂäü');
            } catch (error) {
                console.error('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº:', error);
                showError(`„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                setDebugInfo(`„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
            }
        }

        async function handleLogin() {
            if (!liff.isLoggedIn()) {
                setDebugInfo('„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÈñãÂßã...');
                try {
                    await liff.login();
                    isLoggedIn = true;
                    setDebugInfo('„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                    await fetchProfile();
                } catch (error) {
                    console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                    showError(`„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                    setDebugInfo(`„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ${error.message}`);
                }
            } else {
                setDebugInfo('„É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜÈñãÂßã...');
                liff.logout();
                isLoggedIn = false;
                document.getElementById('profile').classList.add('hidden');
                setDebugInfo('„É≠„Ç∞„Ç¢„Ç¶„ÉàÊàêÂäü');
            }
            updateLoginButton();
        }

        async function sendMessage() {
            setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÈñãÂßã...');
            if (!liff.isLoggedIn()) {
                showError('LINE„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº: Êú™„É≠„Ç∞„Ç§„É≥');
                return;
            }

            if (!liff.isInClient()) {
                showError('„Åì„ÅÆ„Ç¢„Éó„É™„ÅØLINEÂÜÖ„Åß„ÅÆ„ÅøÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ');
                setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº: LINEÂ§ñ„Åß„ÅÆÂÆüË°å');
                return;
            }

            const trainerName = document.getElementById('trainerName').value;
            const friendUrl = document.getElementById('friendUrl').value;
            const adminUrl = document.getElementById('adminUrl').value;
            const managerUrl = document.getElementById('managerUrl').value;
            const customBubblesJson = document.getElementById('customBubbles').value;

            let customBubbles = [];
            try {
                customBubbles = JSON.parse(customBubblesJson);
            } catch (error) {
                showError('„Ç´„Çπ„Çø„É†„Éê„Éñ„É´„ÅÆJSON„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ');
                setDebugInfo(`„Ç´„Çπ„Çø„É†„Éê„Éñ„É´JSON„Ç®„É©„Éº: ${error.message}`);
                return;
            }

            const flexMessage = createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles);

            try {
                await liff.sendMessages([
                    {
                        type: 'flex',
                        altText: 'MY TRAINERÁí∞Â¢ÉÁô∫Ë°åÂÆå‰∫Ü',
                        contents: flexMessage
                    }
                ]);
                setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÊàêÂäü');
                alert('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÊ≠£Â∏∏„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
            } catch (error) {
                console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
                showError(`„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                setDebugInfo(`„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`);
            }
        }

        async function shareMessage() {
            setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±ÊúâÈñãÂßã...');
            if (!liff.isLoggedIn()) {
                showError('LINE„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±Êúâ„Ç®„É©„Éº: Êú™„É≠„Ç∞„Ç§„É≥');
                return;
            }

            const trainerName = document.getElementById('trainerName').value;
            const friendUrl = document.getElementById('friendUrl').value;
            const adminUrl = document.getElementById('adminUrl').value;
            const managerUrl = document.getElementById('managerUrl').value;
            const customBubblesJson = document.getElementById('customBubbles').value;

            let customBubbles = [];
            try {
                customBubbles = JSON.parse(customBubblesJson);
            } catch (error) {
                showError('„Ç´„Çπ„Çø„É†„Éê„Éñ„É´„ÅÆJSON„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ');
                setDebugInfo(`„Ç´„Çπ„Çø„É†„Éê„Éñ„É´JSON„Ç®„É©„Éº: ${error.message}`);
                return;
            }

            const flexMessage = createFlexMessage(trainerName, friendUrl, adminUrl, managerUrl, customBubbles);

            try {
                const result = await liff.shareTargetPicker([
                    {
                        type: 'flex',
                        altText: 'MY TRAINERÁí∞Â¢ÉÁô∫Ë°åÂÆå‰∫Ü',
                        contents: flexMessage
                    }
                ]);
                if (result) {
                    setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±ÊúâÊàêÂäü');
                    alert('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÊ≠£Â∏∏„Å´ÂÖ±Êúâ„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                } else {
                    setDebugInfo('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±Êúâ„Ç≠„É£„É≥„Çª„É´');
                }
            } catch (error) {
                console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±Êúâ„Ç®„É©„Éº:', error);
                showError(`„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂÖ±Êúâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                setDebugInfo(`„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ±Êúâ„Ç®„É©„Éº: ${error.message}`);
            }
        }

        document.getElementById('loginLogoutBtn').addEventListener('click', handleLogin);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('shareMessageBtn').addEventListener('click', shareMessage);

        initializeLiff();
    </script>
</body>
</html>

